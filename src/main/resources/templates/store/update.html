<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<th:block th:replace="~{/fragment/head.html :: header}"></th:block>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
	function searchRoadAddress() {
	    new daum.Postcode({
	        oncomplete: function(data) {
	            // ✅ 도로명 주소만 입력창에 삽입
	            document.getElementById('roadAddress').value = data.roadAddress;
	        }
	    }).open();
	}
</script>

<script>
	document.addEventListener("DOMContentLoaded", function () {
	    // ✅ 대표 이미지 삭제
	    const deleteMainBtn = document.getElementById("delete-main-btn");
		if (deleteMainBtn) {
		    deleteMainBtn.addEventListener("click", function () {
		        const imageId = document.querySelector("input[name='existingMainImageId']").value;
		        if (!imageId) return;
		
		        fetch(`/store/delete/storeimg/${imageId}`)
		            .then(res => res.text())
		            .then(result => {
		            	console.log("삭제 완료:", result);
		                    const mainBox = document.getElementById("main-image-box");
		                    if (mainBox) mainBox.remove();
		                    
		                 	// 업로드 input 동적으로 생성
		                    const uploadField = document.getElementById("main-upload-field");
		                    uploadField.style.display = "block";
		            });
		    });
		}
	
	    // ✅ 배너 이미지 삭제
	   	const deleteBannerBtn = document.getElementById("delete-banner-btn");
		if (deleteBannerBtn) {
			deleteBannerBtn.addEventListener("click", function () {
		        const imageId = document.querySelector("input[name='existingBannerImageId']").value;
		        if (!imageId) return;
			
		        fetch(`/store/delete/storeimg/${imageId}`)
		            .then(res => res.text())
		            .then(result => {
		            	console.log("삭제 완료:", result);
		                    const bannerBox = document.getElementById("banner-image-box");
		                    if (bannerBox) bannerBox.remove();
			                    
		                 	// 업로드 input 동적으로 생성
		                    const uploadField = document.getElementById("banner-upload-field");
		                    uploadField.style.display = "block";
		            });
		    });
		}
	
	    // ✅ 작가 삭제 버튼 처리 (위임 방식)
	    const makerContainer = document.getElementById("maker-container");
	    makerContainer.addEventListener("click", function (e) {
		    if (e.target.classList.contains("delete-maker-btn")) {
		        const group = e.target.closest(".maker-group");
		        const makerId = group.querySelector("input[name='makerIds']")?.value;
		
		        if (makerId) {
		            fetch(`/store/delete/maker/${makerId}`)
		                .then(res => res.text())
		                .then(result => {
		                    if (result === makerId) {
		                        group.remove();
		                    }
		                });
		        } else {
		            group.remove(); // 새로 추가된 작가면 바로 제거
		        }
		    }
		});
	
	    // ✅ 작가 추가 버튼 클릭 시 템플릿 복제
	    const addMakerBtn = document.getElementById("add-maker-btn");
	    const makerTemplate = document.getElementById("maker-template");
	
	    if (addMakerBtn && makerTemplate) {
	        addMakerBtn.addEventListener("click", function () {
	            const clone = makerTemplate.content.cloneNode(true);
	            makerContainer.appendChild(clone);
	        });
	    }
	
	    // ✅ 페이지 처음 로드 시 작가가 0명이라면 인풋 자동 표시
	    if (makerContainer.children.length === 0) {
	        const clone = makerTemplate.content.cloneNode(true);
	        makerContainer.appendChild(clone);
	    }
	});
</script>

</head>
<body>
	<div>
	    <h3>가게 정보 수정</h3>
	    <form method="post" id="update" enctype="multipart/form-data">
	
	        <!-- 기본 정보 -->
	        <div>
	        	<label>고객 ID</label>
	        	<input type="text" name="custId" th:value="${item.custId}" readonly>
	       	</div>
	       	
	        <div>
	        	<label>사업자번호</label>
	        	<input type="text" name="ceonum" th:value="${item.ceonum}" readonly>
	        </div>
	        
	        <div>
	        	<label>가게 이름</label>
	        	<input type="text" name="name" th:value="${item.name}" required>
	        </div>
	        
	        <div>
	            <label>주소</label>
	            <input type="text" id="roadAddress" name="address" th:value="${item.address}" required>
	            <button type="button" onclick="searchRoadAddress()">주소 검색</button>
	        </div>
	
	        <!-- ✅ 대표 이미지 -->
	        <div id="main-image-section">
	            <label>대표 이미지</label>
	            <th:block th:each="img : ${item.storeImg}">
	                <th:block th:if="${img.type == 'main'}">
	                    <div id="main-image-box">
	                        <img th:src="@{'/upload/' + ${img.uuid} + '_' + ${img.filename}}" width="150" />
	                        <input type="hidden" name="existingMainImageId" th:value="${img.id}" />
	                        <button type="button" id="delete-main-btn">삭제</button>
	                    </div>
	                </th:block>
	            </th:block>
	            
	            <!-- 항상 존재, 초기에 안 보이게 -->
			    <div id="main-upload-field" th:style="${#lists.isEmpty(item.storeImg.?[type == 'main'])} ? 'display: block;' : 'display: none;'">
			        <label>대표 이미지 업로드:</label>
			        <input type="file" name="mainImage" accept="image/*" />
			    </div>
	        </div>
	
	        <!-- ✅ 배너 이미지 -->
	        <div id="banner-image-section">
	            <label>배너 이미지</label>
	            <th:block th:each="img : ${item.storeImg}">
	                <th:block th:if="${img.type == 'banner'}">
	                    <div id="banner-image-box">
	                        <img th:src="@{'/upload/' + ${img.uuid} + '_' + ${img.filename}}" width="150" />
	                        <input type="hidden" name="existingBannerImageId" th:value="${img.id}" />
	                        <button type="button" id="delete-banner-btn">삭제</button>
	                    </div>
	                </th:block>
	            </th:block>
	            
	            <!-- 항상 존재, 초기에 안 보이게 -->
			    <div id="banner-upload-field" th:style="${#lists.isEmpty(item.storeImg.?[type == 'banner'])} ? 'display: block;' : 'display: none;'">
			        <label>배너 이미지 업로드:</label>
			        <input type="file" name="bannerImage" accept="image/*" />
			    </div>
	        </div>
	
	        <!-- ✅ 작가 정보 -->
	        <h3>작가 정보</h3>
	        <div id="maker-container">
	            <th:block th:each="maker, iterStat : ${item.maker}">
	                <div class="maker-group">
	                    <input type="hidden" name="makerIds" th:value="${maker.id}" />
	                    <p>이름: <input type="text" name="makerName" th:value="${maker.name}" /></p>
	                    <p>소개: <input type="text" name="makerInfo" th:value="${maker.info}" /></p>
	
	                    <th:block th:if="${maker.filename != null}">
	                        <img th:src="@{'/upload/' + ${maker.uuid} + '_' + ${maker.filename}}" width="150" />
	                        <!-- 기존 이미지 정보 hidden으로 유지 -->
	    					<input type="hidden" name="existingMakerFilenames" th:value="${maker.filename}" />
	    					<input type="hidden" name="existingMakerUuids" th:value="${maker.uuid}" />
	                    </th:block>
	
	                    <button type="button" class="delete-maker-btn">작가 삭제</button>
	                </div>
	            </th:block>
	        </div>
	
	        <!-- ✅ 작가 추가 버튼 -->
	        <button type="button" id="add-maker-btn">작가 추가</button>
	
	        <!-- ✅ 작가 템플릿 -->
	        <template id="maker-template">
	            <div class="maker-group">
	                <hr>
	                <p>이름: <input type="text" name="makerName"/></p>
	                <p>소개: <input type="text" name="makerInfo"/></p>
	                <input type="file" name="makerImages" accept="image/*" />
	                <button type="button" class="delete-maker-btn">작가 삭제</button>
	            </div>
	        </template>
	
	        <!-- 제출 -->
	        <div>
	            <button type="submit">변경</button>
	            <a href="/">취소</a>
	        </div>
	
	    </form>
	</div>
</body>
</html>