<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<th:block th:replace="~{/fragment/head.html :: header}"></th:block>
<script
	src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
	function searchRoadAddress() {
	    new daum.Postcode({
	        oncomplete: function(data) {
	            // ✅ 도로명 주소만 입력창에 삽입
	            document.getElementById('roadAddress').value = data.roadAddress;
	        }
	    }).open();
	}
</script>

<script>
	document.addEventListener("DOMContentLoaded", function () {
	    // ✅ 대표 이미지 삭제
	    const deleteMainBtn = document.getElementById("delete-main-btn");
		if (deleteMainBtn) {
		    deleteMainBtn.addEventListener("click", function () {
		        const imageId = document.querySelector("input[name='existingMainImageId']").value;
		        if (!imageId) return;
		
		        fetch(`/store/delete/storeimg/${imageId}`)
		            .then(res => res.text())
		            .then(result => {
		            	console.log("삭제 완료:", result);
		                    const mainBox = document.getElementById("main-image-box");
		                    if (mainBox) mainBox.remove();
		                    
		                 	// 업로드 input 동적으로 생성
		                    const uploadField = document.getElementById("main-upload-field");
		                    uploadField.style.display = "block";
		            });
		    });
		}
	
	    // ✅ 배너 이미지 삭제
	   	const deleteBannerBtn = document.getElementById("delete-banner-btn");
		if (deleteBannerBtn) {
			deleteBannerBtn.addEventListener("click", function () {
		        const imageId = document.querySelector("input[name='existingBannerImageId']").value;
		        if (!imageId) return;
			
		        fetch(`/store/delete/storeimg/${imageId}`)
		            .then(res => res.text())
		            .then(result => {
		            	console.log("삭제 완료:", result);
		                    const bannerBox = document.getElementById("banner-image-box");
		                    if (bannerBox) bannerBox.remove();
			                    
		                 	// 업로드 input 동적으로 생성
		                    const uploadField = document.getElementById("banner-upload-field");
		                    uploadField.style.display = "block";
		            });
		    });
		}
	
	    // ✅ 작가 삭제 버튼 처리 (위임 방식)
	    const makerContainer = document.getElementById("maker-container");
	    makerContainer.addEventListener("click", function (e) {
		    if (e.target.classList.contains("delete-maker-btn")) {
		        const group = e.target.closest(".maker-group");
		        const makerId = group.querySelector("input[name='makerIds']")?.value;
		
		        if (makerId) {
		            fetch(`/store/delete/maker/${makerId}`)
		                .then(res => res.text())
		                .then(result => {
		                    if (result === makerId) {
		                        group.remove();
		                    }
		                });
		        } else {
		            group.remove(); // 새로 추가된 작가면 바로 제거
		        }
		    }
		});
	
	    // ✅ 작가 추가 버튼 클릭 시 템플릿 복제
	    const addMakerBtn = document.getElementById("add-maker-btn");
	    const makerTemplate = document.getElementById("maker-template");
	
	    if (addMakerBtn && makerTemplate) {
	        addMakerBtn.addEventListener("click", function () {
	            const clone = makerTemplate.content.cloneNode(true);
	            makerContainer.appendChild(clone);
	        });
	    }
	
	    // ✅ 페이지 처음 로드 시 작가가 0명이라면 인풋 자동 표시
	    if (makerContainer.children.length === 0) {
	        const clone = makerTemplate.content.cloneNode(true);
	        makerContainer.appendChild(clone);
	    }
	});
</script>
<style>
body {
	font-family: 'Noto Sans KR', sans-serif;
	background-color: #f8f9fa;
	padding-top: 70px;
}

.container {
	max-width: 800px;
}

.maker-group {
	border: 1px solid #dee2e6;
	border-radius: 8px;
	padding: 20px;
	margin-bottom: 20px;
	background-color: #fff;
}
</style>
</head>
<body>
	<div th:replace="/fragment/nav.html :: nav"></div>

	<div class="container">
		<h3 class="fw-bold text-center mb-4">가게 정보 수정</h3>

		<form method="post" id="update" enctype="multipart/form-data"
			class="card shadow-sm p-4 bg-white">
			<div class="mb-3">
				<label class="form-label">고객 ID</label> <input type="text"
					class="form-control" name="custId" th:value="${item.custId}"
					readonly>
			</div>
			<div class="mb-3">
				<label class="form-label">사업자번호</label> <input type="text"
					class="form-control" name="ceonum" th:value="${item.ceonum}"
					readonly>
			</div>
			<div class="mb-3">
				<label class="form-label">가게 이름</label> <input type="text"
					class="form-control" name="name" th:value="${item.name}" required>
			</div>
			<div class="mb-3">
				<label class="form-label">주소</label>
				<div class="input-group">
					<input type="text" id="roadAddress" name="address"
						class="form-control" th:value="${item.address}" required>
					<button type="button" class="btn btn-outline-secondary"
						onclick="searchRoadAddress()">주소 검색</button>
				</div>
			</div>

			<!-- 대표 이미지 -->
			<div class="mb-3">
				<label class="form-label">대표 이미지</label>
				<th:block th:each="img : ${item.storeImg}">
					<th:block th:if="${img.type == 'main'}">
						<div id="main-image-box" class="mb-2">
							<img th:src="@{'/upload/' + ${img.uuid} + '_' + ${img.filename}}"
								class="img-thumbnail" width="150"> <input type="hidden"
								name="existingMainImageId" th:value="${img.id}">
							<button type="button" class="btn btn-sm btn-danger mt-1"
								id="delete-main-btn">삭제</button>
						</div>
					</th:block>
				</th:block>
				<div id="main-upload-field"
					th:style="${#lists.isEmpty(item.storeImg.?[type == 'main'])} ? 'display: block;' : 'display: none;'">
					<input type="file" name="mainImage" accept="image/*"
						class="form-control">
				</div>
			</div>

			<!-- 배너 이미지 -->
			<div class="mb-3">
				<label class="form-label">배너 이미지</label>
				<th:block th:each="img : ${item.storeImg}">
					<th:block th:if="${img.type == 'banner'}">
						<div id="banner-image-box" class="mb-2">
							<img th:src="@{'/upload/' + ${img.uuid} + '_' + ${img.filename}}"
								class="img-thumbnail" width="150"> <input type="hidden"
								name="existingBannerImageId" th:value="${img.id}">
							<button type="button" class="btn btn-sm btn-danger mt-1"
								id="delete-banner-btn">삭제</button>
						</div>
					</th:block>
				</th:block>
				<div id="banner-upload-field"
					th:style="${#lists.isEmpty(item.storeImg.?[type == 'banner'])} ? 'display: block;' : 'display: none;'">
					<input type="file" name="bannerImage" accept="image/*"
						class="form-control">
				</div>
			</div>

			<!-- 작가 정보 -->
			<h5 class="mt-4">작가 정보</h5>
			<div id="maker-container">
				<th:block th:each="maker : ${item.maker}">
					<div class="maker-group">
						<input type="hidden" name="makerIds" th:value="${maker.id}">
						<div class="mb-2">
							<label>이름</label> <input type="text" class="form-control"
								name="makerName" th:value="${maker.name}" required>
						</div>
						<div class="mb-2">
							<label>소개</label> <input type="text" class="form-control"
								name="makerInfo" th:value="${maker.info}" required>
						</div>
						<th:block th:if="${maker.filename != null}">
							<img
								th:src="@{'/upload/' + ${maker.uuid} + '_' + ${maker.filename}}"
								class="img-thumbnail mb-2" width="150">
							<input type="hidden" name="existingMakerFilenames"
								th:value="${maker.filename}">
							<input type="hidden" name="existingMakerUuids"
								th:value="${maker.uuid}">
						</th:block>
						<button type="button"
							class="btn btn-outline-danger btn-sm delete-maker-btn">작가
							삭제</button>
					</div>
				</th:block>
			</div>

			<template id="maker-template">
				<div class="maker-group">
					<hr>
					<div class="mb-2">
						<label>이름</label> <input type="text" class="form-control"
							name="makerName" required>
					</div>
					<div class="mb-2">
						<label>소개</label> <input type="text" class="form-control"
							name="makerInfo" required>
					</div>
					<input type="file" class="form-control" name="makerImages"
						accept="image/*">
					<button type="button"
						class="btn btn-outline-danger btn-sm mt-2 delete-maker-btn">작가
						삭제</button>
				</div>
			</template>

			<div class="mb-4">
				<button type="button" id="add-maker-btn"
					class="btn btn-outline-primary btn-sm">작가 추가</button>
			</div>

			<div class="d-flex justify-content-between">
				<button type="submit" class="btn btn-warning text-dark fw-bold px-4">변경</button>
				<a href="/" class="btn btn-outline-secondary px-4">취소</a>
			</div>
		</form>
	</div>
</body>
</html>